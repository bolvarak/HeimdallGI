///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// Headers //////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include "ErrorController.h"

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// Namespace ////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

namespace HeimdallGI {

	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/// Globals /////////////////////////////////////////////////////////////////////////////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	ErrorController* ErrorController::mInstance = NULL;

	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/// Singleton ///////////////////////////////////////////////////////////////////////////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	ErrorController* ErrorController::Instance(bool bReset) {
		// Check for an existing instance or a reset flag
		if ((mInstance == NULL) || (bReset = true)) {
			// Instantiate the class
			mInstance = new ErrorController;
		}
		// Return the instance
		return mInstance;
	}

	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/// Constructor /////////////////////////////////////////////////////////////////////////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	ErrorController::ErrorController(QObject* qoParent) : QObject(qoParent) {}

	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/// Handlers ////////////////////////////////////////////////////////////////////////////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	void ErrorController::NotFound(CGI*& objRequest, View*& objResponse) {
		// Define the template
		QString strTemplate = Configuration::Get("Templates.notFound").toString();
		// Set the view file
		objResponse->SetTemplate(strTemplate.isEmpty() ? ":/templates/notFound.hgt" : strTemplate);
		// Set the page title
		objResponse->SetPageValue("pageTitle", "404 Not Found");
		// Set the REQUEST_URI
		objResponse->SetPageValue("requestURI", objRequest->GetRequestHeader("REQUEST_URI"));
		// Set debug output
		objResponse->SetPageValue("showStackTrace", Configuration::Get("Environment.showDebug").toBool());
		// Set the stack trace
		objResponse->SetPageValue("stackTrace", "${STACK_TRACE}");
	}

	void ErrorController::ServerFault(CGI*& objRequest, View*& objResponse, QString strMessage) {
		// Define the themplate
		QString strTemplate = Configuration::Get("Template.serverFault").toString();
		// Set the view file
		objResponse->SetTemplate(strTemplate.isEmpty() ? ":/templates/serverFault.hgt" : strTemplate);
		// Set the page title
		objResponse->SetPageValue("pageTitle", "500 Internal Server Error");
		// Set the error message
		objResponse->SetPageValue("errorMessage", strMessage);
		// Set debug output
		objResponse->SetPageValue("showStackTrace", Configuration::Get("Environment.showDebug").toBool());
		// Set the stack trace
		objResponse->SetPageValue("stackTrace", "${STACK_TRACE}");
	}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// End Namespace ////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}
